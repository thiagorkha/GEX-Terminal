<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantGEX Terminal | Full Greeks Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body {
            background-color: #020617;
            color: #f1f5f9;
            font-family: 'Inter', system-ui, sans-serif;
        }
        input[type="file"]::file-selector-button {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            margin-right: 1rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .metric-label {
            font-size: 10px;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        .input-dark {
            background: transparent;
            font-weight: bold;
            width: 100%;
            text-align: center;
            outline: none;
            color: white;
        }
        .input-dark:focus {
            color: #60a5fa;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400 flex items-center gap-2">
                    üìä QuantGEX Terminal <span class="text-xs font-mono bg-blue-500/20 px-2 py-1 rounded text-blue-300">v4.6 PRO</span>
                </h1>
                <p class="text-slate-400">Fluxo Profissional: Delta, Gamma, Theta, Vega & IV Rank</p>
            </div>
            
            <!-- Inputs Superiores -->
            <div class="flex flex-wrap gap-3 justify-center">
                <div class="glass-card p-2 rounded-lg text-center min-w-[100px]">
                    <span class="metric-label">Pre√ßo Spot</span>
                    <input type="number" id="spotPrice" value="100.00" step="0.01" class="input-dark text-lg">
                </div>
                <div class="glass-card p-2 rounded-lg text-center min-w-[100px]">
                    <span class="metric-label">Call IV Rank</span>
                    <input type="number" id="callIvRank" value="50" class="input-dark text-lg">
                </div>
                <div class="glass-card p-2 rounded-lg text-center min-w-[100px]">
                    <span class="metric-label">Put IV Rank</span>
                    <input type="number" id="putIvRank" value="50" class="input-dark text-lg">
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <div class="lg:col-span-3 glass-card p-6 rounded-xl border-l-4 border-blue-500">
                <h2 class="text-sm font-semibold text-blue-300 uppercase mb-4">üìÇ Importar Dados (Colunas: Strike, Delta, Gamma, Theta, Vega, IV, DTE, OI)</h2>
                <input type="file" id="excelInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-400">
            </div>
            <div class="glass-card p-6 rounded-xl flex flex-col justify-center border-l-4 border-purple-500">
                <span class="metric-label">GEX Total (Notional)</span>
                <div id="totalGexValue" class="text-xl font-bold text-white mt-1">--</div>
                <div id="gexStatus" class="text-[9px] uppercase font-bold mt-1">Aguardando dados...</div>
            </div>
        </div>

        <!-- Metric Cards Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8 text-center">
            <div class="glass-card p-4 rounded-xl border-t-2 border-green-500">
                <span class="metric-label">Call Wall</span>
                <div id="callWallValue" class="text-lg font-bold text-green-400">--</div>
                <div id="callWallVolume" class="text-[9px] text-slate-500 font-mono mt-1">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-red-500">
                <span class="metric-label">Put Wall</span>
                <div id="putWallValue" class="text-lg font-bold text-red-400">--</div>
                <div id="putWallVolume" class="text-[9px] text-slate-500 font-mono mt-1">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-yellow-500">
                <span class="metric-label">Gamma Pin</span>
                <div id="gammaPinValue" class="text-lg font-bold text-yellow-400">--</div>
                <div class="text-[9px] text-slate-500 mt-1 uppercase">Ponto de Estabilidade</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-orange-500">
                <span class="metric-label">Gamma Flip</span>
                <div id="gammaFlipValue" class="text-lg font-bold text-orange-400">--</div>
                <div class="text-[9px] text-slate-500 mt-1 uppercase">Ponto de Invers√£o</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-emerald-500">
                <span class="metric-label">Theta Total</span>
                <div id="totalThetaValue" class="text-lg font-bold text-emerald-400">--</div>
                <div class="text-[9px] text-slate-500 mt-1 uppercase">Decaimento/Dia</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-blue-500">
                <span class="metric-label">Charm Hedge</span>
                <div id="charmHedgeValue" class="text-lg font-bold text-blue-400">--</div>
                <div class="text-[9px] text-slate-500 mt-1 uppercase">Hedge Temporal</div>
            </div>
        </div>

        <!-- Charts and Insights -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 glass-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Visualiza√ß√£o de Gregas</h3>
                    <select id="chartMetric" class="bg-slate-800 text-[10px] rounded px-2 py-1 outline-none border border-slate-700">
                        <option value="totalGex">Gamma Exposure (GEX)</option>
                        <option value="totalVega">Vega Exposure</option>
                        <option value="totalTheta">Theta (Time Decay)</option>
                        <option value="totalDelta">Notional Delta</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Monitor de Liquidez (Corrigido e Aprimorado) -->
                <div class="glass-card p-6 rounded-xl border-b-4 border-yellow-600">
                    <h3 class="text-sm font-bold text-yellow-300 uppercase mb-4 flex items-center gap-2">
                        ‚ö° Monitor de Liquidez Professional
                    </h3>
                    <div id="advancedInsights" class="space-y-4">
                        <div class="text-center py-4">
                            <p class="text-slate-500 text-[11px] italic">Aguardando processamento de dados para an√°lise de fluxo...</p>
                        </div>
                    </div>
                </div>

                <!-- Strategic Tactics -->
                <div class="glass-card p-6 rounded-xl border-b-4 border-cyan-600">
                    <h3 class="text-sm font-bold text-cyan-300 uppercase mb-4">üéØ Estrat√©gia Recomendada</h3>
                    <div id="tacticContent" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="mt-8 glass-card rounded-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-slate-500 text-[9px] uppercase font-bold">
                        <tr>
                            <th class="p-4">Strike</th>
                            <th class="p-4">GEX Net</th>
                            <th class="p-4">Delta Net (M)</th>
                            <th class="p-4">Theta (Di√°rio)</th>
                            <th class="p-4">Vega (1% IV)</th>
                            <th class="p-4">DTE</th>
                            <th class="p-4">IV %</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="divide-y divide-white/5 font-mono text-[11px]"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let lastRawData = [];

        // UI Event Listeners
        ['spotPrice', 'callIvRank', 'putIvRank', 'chartMetric'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateData);
        });

        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                processData(json);
            };
            reader.readAsArrayBuffer(file);
        });

        function parseNum(val) {
            if (val === undefined || val === null || val === "") return 0;
            let clean = val.toString().replace(/R\$/g, '').replace(/\s/g, '').replace('%', '');
            if (clean.includes(',') && clean.includes('.')) clean = clean.replace(/\./g, '').replace(',', '.');
            else clean = clean.replace(',', '.');
            return parseFloat(clean) || 0;
        }

        function processData(json) {
            lastRawData = json.map(row => {
                const findKey = (list) => {
                    const keys = Object.keys(row);
                    return keys.find(k => list.some(l => k.toLowerCase().trim() === l.toLowerCase())) || null;
                };

                return {
                    tipo: (row[findKey(['tipo', 'call/put', 'type', 'c/p'])] || "").toString().toLowerCase(),
                    strike: parseNum(row[findKey(['strike', 'pre√ßo exerc√≠cio', 'preco', 'exercicio'])]),
                    oi: parseNum(row[findKey(['oi', 'open interest', 'aberto', 'contratos'])]),
                    gamma: parseNum(row[findKey(['gamma', 'gama', 'gex'])]),
                    delta: parseNum(row[findKey(['delta', 'dlt'])]),
                    theta: parseNum(row[findKey(['theta', 'teta'])]),
                    vega: parseNum(row[findKey(['vega'])]),
                    iv: parseNum(row[findKey(['iv', 'volatilidade'])]),
                    dte: parseNum(row[findKey(['dte', 'prazo', 'vencimento'])])
                };
            }).filter(r => r.strike > 0);
            updateData();
        }

        function updateData() {
            if (!lastRawData.length) return;
            const spot = parseFloat(document.getElementById('spotPrice').value);
            const strikeMap = {};

            lastRawData.forEach(row => {
                if (!strikeMap[row.strike]) {
                    strikeMap[row.strike] = { strike: row.strike, totalGex: 0, totalDelta: 0, totalTheta: 0, totalVega: 0, iv: row.iv, dte: row.dte, gCall: 0, gPut: 0, absGamma: 0 };
                }
                const mult = 100 * spot; 
                const gexValue = row.gamma * row.oi * mult;
                const delta = row.delta * row.oi * mult;
                const theta = row.theta * row.oi * 100; 
                const vega = row.vega * row.oi * 100;

                const isCall = row.tipo.includes('c');
                strikeMap[row.strike].totalGex += isCall ? gexValue : -gexValue;
                strikeMap[row.strike].totalDelta += delta; 
                strikeMap[row.strike].totalTheta += theta;
                strikeMap[row.strike].totalVega += vega;
                strikeMap[row.strike].absGamma += Math.abs(gexValue);
                
                if(isCall) strikeMap[row.strike].gCall += gexValue;
                else strikeMap[row.strike].gPut -= gexValue;
            });

            const df = Object.values(strikeMap).sort((a,b) => a.strike - b.strike);
            renderDashboard(df, spot);
        }

        function renderDashboard(df, spot) {
            const callRank = parseFloat(document.getElementById('callIvRank').value);
            const putRank = parseFloat(document.getElementById('putIvRank').value);

            const lv = {
                callWall: df.reduce((a, b) => a.gCall > b.gCall ? a : b),
                putWall: df.reduce((a, b) => a.gPut < b.gPut ? a : b),
                gammaPin: df.reduce((a, b) => a.absGamma > b.absGamma ? a : b).strike,
                gammaFlip: df.reduce((a, b) => Math.abs(a.totalGex) < Math.abs(b.totalGex) ? a : b).strike,
                totalVega: df.reduce((a, b) => a + b.totalVega, 0),
                totalTheta: df.reduce((a, b) => a + b.totalTheta, 0),
                totalDelta: df.reduce((a, b) => a + b.totalDelta, 0),
                totalGexNet: df.reduce((a, b) => a + b.totalGex, 0),
                avgDte: df.reduce((a, b) => a + b.dte, 0) / df.length
            };

            // Notional GEX Info
            const gexEl = document.getElementById('totalGexValue');
            const gexStatusEl = document.getElementById('gexStatus');
            gexEl.innerText = `R$ ${(lv.totalGexNet/1e6).toFixed(1)}M`;
            if(lv.totalGexNet > 0) {
                gexEl.className = "text-xl font-bold text-green-400 mt-1";
                gexStatusEl.innerText = "Dealers Long Gamma (Est√°vel)";
                gexStatusEl.className = "text-[9px] uppercase font-bold mt-1 text-green-500/80";
            } else {
                gexEl.className = "text-xl font-bold text-red-400 mt-1";
                gexStatusEl.innerText = "Dealers Short Gamma (Explosivo)";
                gexStatusEl.className = "text-[9px] uppercase font-bold mt-1 text-red-500/80";
            }

            // Metric Cards
            document.getElementById('callWallValue').innerText = `$ ${lv.callWall.strike.toFixed(2)}`;
            document.getElementById('callWallVolume').innerText = `${(lv.callWall.gCall/1e6).toFixed(1)}M`;
            document.getElementById('putWallValue').innerText = `$ ${lv.putWall.strike.toFixed(2)}`;
            document.getElementById('putWallVolume').innerText = `${(lv.putWall.gPut/1e6).toFixed(1)}M`;
            document.getElementById('gammaPinValue').innerText = `$ ${lv.gammaPin.toFixed(2)}`;
            document.getElementById('gammaFlipValue').innerText = `$ ${lv.gammaFlip.toFixed(2)}`;
            document.getElementById('totalThetaValue').innerText = `R$ ${(lv.totalTheta/1e3).toFixed(1)}k`;
            
            const charmEst = (lv.totalDelta * 0.05) / lv.avgDte; 
            document.getElementById('charmHedgeValue').innerText = `${(charmEst/1e3).toFixed(1)}k / dia`;

            // Professional Liquidity Monitor Logic
            let insightHtml = `<div class="space-y-3">`;
            
            // 1. IV Context
            const ivClass = Math.max(callRank, putRank) > 70 ? 'text-purple-400' : 'text-blue-400';
            insightHtml += `
                <div class="p-3 bg-white/5 rounded border-l-2 border-blue-500">
                    <p class="text-[9px] text-slate-500 uppercase font-bold">Estrutura de Volatilidade</p>
                    <p class="text-[11px] font-semibold mt-1 ${ivClass}">
                        IV Rank M√©dio: ${((callRank + putRank) / 2).toFixed(1)}% | 
                        ${Math.max(callRank, putRank) > 75 ? 'Premium Atractiveness: HIGH' : 'Premium Atractiveness: NEUTRAL'}
                    </p>
                </div>
            `;

            // 2. Market Maker Positioning (Gamma Analysis)
            const gexConcentration = Math.abs(lv.totalGexNet) / (df.reduce((a,b) => a + b.absGamma, 0) || 1);
            const skewInfo = lv.totalGexNet > 0 ? "LONG GAMMA" : "SHORT GAMMA";
            const gexColor = lv.totalGexNet > 0 ? "text-green-400" : "text-red-400";
            
            insightHtml += `
                <div class="p-3 bg-white/5 rounded border-l-2 border-yellow-500">
                    <p class="text-[9px] text-slate-500 uppercase font-bold">Exposi√ß√£o dos Market Makers</p>
                    <p class="text-[11px] font-semibold mt-1 ${gexColor}">
                        Regime: ${skewInfo} | Concentra√ß√£o: ${(gexConcentration * 100).toFixed(1)}%
                    </p>
                    <p class="text-[10px] text-slate-400 mt-1 leading-tight">
                        ${lv.totalGexNet > 0 
                            ? "Market Makers est√£o provendo liquidez. Volatilidade tende a ser contida e reversiva √† m√©dia." 
                            : "Risco de 'Negative Feedback Loop'. Movimentos direcionais tendem a ser exacerbados por hedges."}
                    </p>
                </div>
            `;

            // 3. Liquidity Gravity (Walls)
            const distToCall = Math.abs((lv.callWall.strike - spot) / spot * 100).toFixed(1);
            const distToPut = Math.abs((lv.putWall.strike - spot) / spot * 100).toFixed(1);
            
            insightHtml += `
                <div class="p-3 bg-white/5 rounded border-l-2 border-cyan-500">
                    <p class="text-[9px] text-slate-500 uppercase font-bold">Gravidade de Liquidez</p>
                    <div class="flex justify-between mt-1 text-[10px]">
                        <span class="text-green-400">Call Wall: +${distToCall}%</span>
                        <span class="text-red-400">Put Wall: -${distToPut}%</span>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1">
                        Magnetismo do Pin: ${Math.abs(lv.gammaPin - spot) < (spot * 0.02) ? "FORTE (Proximidade Cr√≠tica)" : "FRACO"}
                    </p>
                </div>
            `;

            document.getElementById('advancedInsights').innerHTML = insightHtml;

            // Strategy Tactic
            let stratHtml = "";
            if (lv.avgDte < 5) {
                stratHtml = createStratCard("Pinning Strategy", "Vencimento curto + Gamma Pin. O pre√ßo tende a orbitar o Pin.", "yellow", 
                `Exemplo: Iron Butterfly no strike ${lv.gammaPin.toFixed(0)} para lucrar com a imobiliza√ß√£o do pre√ßo.`);
            } else if (callRank > 80 && putRank > 80) {
                stratHtml = createStratCard("Short Volatility", "IV Rank extremo favorece coleta de pr√™mios.", "purple",
                `Exemplo: Venda de Strangle (distante das Walls) nos strikes ${lv.putWall.strike.toFixed(0)} e ${lv.callWall.strike.toFixed(0)}.`);
            } else if (lv.totalGexNet < 0) {
                stratHtml = createStratCard("Long Gamma / Convexity", "Comprar vol barata antes da explos√£o.", "red",
                `Exemplo: Compra de Straddle no strike ${lv.gammaFlip.toFixed(0)} visando lucrar com o aumento da vol realizada.`);
            } else {
                stratHtml = createStratCard("Trend Following", "GEX positivo providencia suporte/resist√™ncia nas Walls.", "blue",
                `Exemplo: Trava de Alta (Bull Call Spread) buscando o alvo na Call Wall em ${lv.callWall.strike.toFixed(0)}.`);
            }
            document.getElementById('tacticContent').innerHTML = stratHtml;

            // Table
            document.getElementById('dataTable').innerHTML = df.map(r => `
                <tr class="hover:bg-white/5">
                    <td class="p-4 font-bold text-slate-300">${r.strike.toFixed(2)}</td>
                    <td class="p-4 ${r.totalGex >= 0 ? 'text-green-400' : 'text-red-400'}">${(r.totalGex/1e6).toFixed(2)}M</td>
                    <td class="p-4 text-yellow-500">${(r.totalDelta/1e6).toFixed(2)}M</td>
                    <td class="p-4 text-emerald-400">${(r.totalTheta/1e3).toFixed(1)}k</td>
                    <td class="p-4 text-purple-400">${(r.totalVega/1e3).toFixed(1)}k</td>
                    <td class="p-4 text-cyan-400">${r.dte}d</td>
                    <td class="p-4 text-slate-500">${r.iv.toFixed(1)}%</td>
                </tr>
            `).join('');

            renderChart(df, spot);
        }

        function createStratCard(title, desc, color, example) {
            return `<div class="p-3 bg-${color}-500/10 rounded border border-${color}-500/30">
                <p class="text-[11px] text-${color}-400 font-bold uppercase">${title}</p>
                <p class="text-[10px] text-slate-300 leading-tight mt-1 mb-2">${desc}</p>
                <div class="pt-2 border-t border-${color}-500/20">
                    <p class="text-[9px] text-${color}-200/70 italic font-mono">${example}</p>
                </div>
            </div>`;
        }

        function renderChart(df, spot) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const metric = document.getElementById('chartMetric').value;
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: df.map(r => r.strike),
                    datasets: [{
                        label: metric,
                        data: df.map(r => r[metric]),
                        backgroundColor: df.map(r => r[metric] >= 0 ? 'rgba(59, 130, 246, 0.5)' : 'rgba(239, 68, 68, 0.5)'),
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#64748b', font: { size: 9 } } },
                        x: { ticks: { color: '#64748b', font: { size: 9 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
