<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantGEX Terminal | Op√ß√µes & Gamma Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body {
            background-color: #020617;
            color: #f1f5f9;
            font-family: 'Inter', system-ui, sans-serif;
        }
        input[type="file"]::file-selector-button {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #1d4ed8;
        }
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }
        .indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400 flex items-center gap-2">
                    üìä QuantGEX Terminal <span class="text-xs font-mono bg-blue-500/20 px-2 py-1 rounded text-blue-300">v3.5 PRO</span>
                </h1>
                <p class="text-slate-400">Intelig√™ncia de Market Making & Probabilidades T√°ticas</p>
            </div>
            <div class="flex gap-4">
                <div class="glass-card p-3 rounded-lg text-center min-w-[150px]">
                    <span class="block text-[10px] uppercase text-slate-400 mb-1 font-bold">Pre√ßo Spot (Ativo)</span>
                    <input type="number" id="spotPrice" value="100.00" step="0.01" class="bg-transparent text-xl font-bold w-full text-center outline-none text-white focus:text-blue-400 transition-colors">
                </div>
            </div>
        </header>

        <!-- Import Section -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="md:col-span-3 glass-card p-6 rounded-xl border-l-4 border-blue-500">
                <h2 class="text-sm font-semibold mb-4 text-blue-300 uppercase tracking-wider">üìÅ Importar Cadeia de Op√ß√µes</h2>
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <input type="file" id="excelInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-400">
                    <div class="flex gap-2">
                        <div class="text-[10px] text-slate-400 bg-slate-800/50 p-2 rounded whitespace-nowrap">Headers: Strike, Gamma, OI, Volume</div>
                    </div>
                </div>
            </div>
            <div class="glass-card p-6 rounded-xl flex flex-col justify-center">
                <span class="text-xs text-slate-400 uppercase font-bold">Estado do Gamma</span>
                <div id="netGexValue" class="text-xl font-bold text-white mt-1">--</div>
                <div id="regimeBadge" class="mt-2 inline-block text-[9px] font-bold uppercase p-1 rounded text-center">Aguardando...</div>
            </div>
        </div>

        <!-- Metric Cards -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="glass-card p-4 rounded-xl border-t-2 border-green-500/50">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Call Wall</span>
                <div id="callWallValue" class="text-lg font-bold text-green-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-red-500/50">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Put Wall</span>
                <div id="putWallValue" class="text-lg font-bold text-red-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-orange-500/50">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Gamma Flip</span>
                <div id="gammaFlipValue" class="text-lg font-bold text-orange-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-purple-500/50">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Gamma Pin</span>
                <div id="gammaPinValue" class="text-lg font-bold text-purple-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-emerald-500/50">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Vol. Sess√£o</span>
                <div id="totalVolumeVal" class="text-lg font-bold text-emerald-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-cyan-500/50">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Nocional Aberto</span>
                <div id="totalOiNocional" class="text-lg font-bold text-cyan-400">--</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Visual Analytics -->
            <div class="lg:col-span-2 glass-card p-6 rounded-xl">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="indicator-dot bg-blue-500"></span> Perfil de Exposi√ß√£o do Dealer
                    </h3>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-[10px] text-slate-400 cursor-pointer hover:text-white transition">
                            <input type="checkbox" id="showVolumeLine" checked class="rounded border-slate-700 bg-slate-900"> Financeiro
                        </label>
                        <label class="flex items-center gap-2 text-[10px] text-slate-400 cursor-pointer hover:text-white transition">
                            <input type="checkbox" id="showOiLine" checked class="rounded border-slate-700 bg-slate-900"> OI Nocional
                        </label>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="gexChart"></canvas>
                </div>
            </div>

            <!-- New Strategy & MM Panel -->
            <div class="space-y-6">
                <!-- MM Flow -->
                <div class="glass-card p-6 rounded-xl border-b-4 border-blue-600">
                    <h3 class="text-sm font-bold text-blue-300 uppercase mb-4 flex items-center gap-2">
                        ü§ñ A√ß√£o do Market Maker
                    </h3>
                    <div id="mmActionContent" class="space-y-3">
                        <div class="text-slate-500 text-[11px] italic">Importe dados para simular o comportamento dos dealers.</div>
                    </div>
                </div>

                <!-- Strategic Positioning -->
                <div class="glass-card p-6 rounded-xl border-b-4 border-emerald-600">
                    <h3 class="text-sm font-bold text-emerald-300 uppercase mb-4 flex items-center gap-2">
                        üéØ Estrat√©gias Sugeridas
                    </h3>
                    <div id="strategyContent" class="space-y-3">
                        <!-- Conte√∫do din√¢mico -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Panel -->
        <div class="mt-8 glass-card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="font-bold text-xs uppercase text-slate-400 tracking-wider">Monitor de Microestrutura por Strike</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-black/40 text-slate-500 text-[9px] uppercase font-bold tracking-tighter">
                        <tr>
                            <th class="p-4">Strike</th>
                            <th class="p-4">Domin√¢ncia</th>
                            <th class="p-4">GEX Net</th>
                            <th class="p-4">OI Nocional</th>
                            <th class="p-4">Volume</th>
                            <th class="p-4">Concentra√ß√£o</th>
                            <th class="p-4 text-right">GEX/Vol</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="divide-y divide-white/5 font-mono text-[11px]">
                        <!-- Linhas din√¢micas -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let lastRawData = [];

        // UI Listeners
        document.getElementById('showVolumeLine').addEventListener('change', updateData);
        document.getElementById('showOiLine').addEventListener('change', updateData);
        document.getElementById('spotPrice').addEventListener('change', updateData);

        // --- EXCEL PARSER ---
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                processImportedData(json);
            };
            reader.readAsArrayBuffer(file);
        });

        function parseNum(val) {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            let clean = val.toString().replace(/R\$/g, '').replace(/\s/g, '');
            if (clean.includes(',') && clean.includes('.')) {
                clean = clean.replace(/\./g, '').replace(',', '.');
            } else {
                clean = clean.replace(',', '.');
            }
            return parseFloat(clean) || 0;
        }

        function processImportedData(json) {
            lastRawData = json.map(row => {
                const findKey = (list) => {
                    const keys = Object.keys(row);
                    return keys.find(k => list.some(l => k.toLowerCase().trim() === l.toLowerCase())) || null;
                };
                return {
                    tipo: (row[findKey(['tipo', 'call/put', 'type', 'c/p'])] || "").toString().toLowerCase(),
                    strike: parseNum(row[findKey(['strike', 'pre√ßo exerc√≠cio', 'preco', 'exercicio'])]),
                    oi: parseNum(row[findKey(['oi', 'open interest', 'aberto', 'contratos'])]),
                    gamma: parseNum(findKey(['gamma', 'gama', 'gex']) ? row[findKey(['gamma', 'gama', 'gex'])] : 0),
                    volume: parseNum(row[findKey(['volume financeiro', 'volume_financeiro', 'volume', 'vol', 'financeiro', 'valor'])])
                };
            }).filter(r => !isNaN(r.strike) && r.strike > 0);
            updateData();
        }

        // --- QUANT ENGINE v3.5 ---
        function calculateMetrics(data, spot) {
            const strikeMap = {};
            data.forEach(row => {
                if (!strikeMap[row.strike]) {
                    strikeMap[row.strike] = { strike: row.strike, gexCall: 0, gexPut: 0, oi: 0, volume: 0, oiCall: 0, oiPut: 0 };
                }
                const gexVal = row.gamma * row.oi * 100 * spot;
                const oiNocional = row.oi * 100 * spot;
                if (row.tipo.includes('c')) {
                    strikeMap[row.strike].gexCall += gexVal;
                    strikeMap[row.strike].oiCall += oiNocional;
                } else {
                    strikeMap[row.strike].gexPut -= gexVal;
                    strikeMap[row.strike].oiPut += oiNocional;
                }
                strikeMap[row.strike].oi += row.oi;
                strikeMap[row.strike].volume += row.volume;
            });

            return Object.values(strikeMap).map(s => ({
                ...s,
                totalGex: s.gexCall + s.gexPut,
                totalOiNocional: s.oiCall + s.oiPut,
                dominance: Math.abs(s.gexCall) >= Math.abs(s.gexPut) ? 'CALL' : 'PUT',
                volRatio: s.volume > 0 ? (Math.abs(s.gexCall + s.gexPut) / s.volume) : 0,
                concentration: (s.volume > 0) ? (s.oi / s.volume) : 0
            })).sort((a,b) => a.strike - b.strike);
        }

        function getLevels(df) {
            if (!df.length) return null;
            const callWall = df.reduce((prev, curr) => (curr.gexCall > prev.gexCall) ? curr : prev).strike;
            const putWall = df.reduce((prev, curr) => (curr.gexPut < prev.gexPut) ? curr : prev).strike;
            const gammaPin = df.reduce((prev, curr) => (Math.abs(curr.totalGex) > Math.abs(prev.totalGex)) ? curr : prev).strike;
            const gammaFlip = df.reduce((prev, curr) => (Math.abs(curr.totalGex) < Math.abs(prev.totalGex)) ? curr : prev).strike;
            const netGex = df.reduce((a, b) => a + b.totalGex, 0);
            return { callWall, putWall, gammaPin, gammaFlip, netGex, 
                     totalVol: df.reduce((a,b) => a + b.volume, 0),
                     totalOiNocional: df.reduce((a,b) => a + b.totalOiNocional, 0) };
        }

        function updateUI(df, lv, spot) {
            if (!lv) return;
            document.getElementById('netGexValue').innerText = `R$ ${(lv.netGex/1e6).toFixed(2)}M`;
            document.getElementById('totalVolumeVal').innerText = `R$ ${(lv.totalVol/1e6).toFixed(2)}M`;
            document.getElementById('totalOiNocional').innerText = `R$ ${(lv.totalOiNocional/1e6).toFixed(2)}M`;
            document.getElementById('callWallValue').innerText = `$ ${lv.callWall.toFixed(2)}`;
            document.getElementById('putWallValue').innerText = `$ ${lv.putWall.toFixed(2)}`;
            document.getElementById('gammaFlipValue').innerText = `$ ${lv.gammaFlip.toFixed(2)}`;
            document.getElementById('gammaPinValue').innerText = `$ ${lv.gammaPin.toFixed(2)}`;

            // Badge Regime
            const badge = document.getElementById('regimeBadge');
            const isLongGamma = lv.netGex > 0;
            badge.innerText = isLongGamma ? 'üõ°Ô∏è LONG GAMMA (Dealer Pro-Trend)' : 'üå™Ô∏è SHORT GAMMA (Dealer Reativo)';
            badge.className = `mt-2 inline-block text-[9px] font-bold uppercase p-1 rounded text-center ${isLongGamma ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;

            // --- MM ACTION LOGIC ---
            let mmHtml = `<div class="space-y-3">`;
            if (isLongGamma) {
                mmHtml += `<div class="p-3 bg-green-500/5 rounded border border-green-500/20">
                    <p class="text-[11px] text-green-300 font-bold mb-1">PROVEDOR DE ESTABILIDADE</p>
                    <p class="text-[10px] text-slate-400 leading-relaxed">Dealers est√£o comprando nas quedas e vendendo nas altas para rebalancear deltas. O mercado tende a ser "pegajoso" e com baixa volatilidade percebida.</p>
                </div>`;
            } else {
                mmHtml += `<div class="p-3 bg-red-500/5 rounded border border-red-500/20">
                    <p class="text-[11px] text-red-300 font-bold mb-1">ACELERADOR DE TEND√äNCIA</p>
                    <p class="text-[10px] text-slate-400 leading-relaxed">Os Market Makers precisam vender conforme o pre√ßo cai e comprar conforme sobe. Isso cria "v√°cuos" de liquidez e movimentos explosivos.</p>
                </div>`;
            }
            
            const distanceToFlip = ((spot / lv.gammaFlip) - 1) * 100;
            mmHtml += `<div class="p-3 bg-slate-800/50 rounded border border-white/5">
                <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Ponto de Inflex√£o (Hedge Reverso)</p>
                <p class="text-[11px] text-slate-300 font-mono">Spot est√° a ${distanceToFlip.toFixed(2)}% do Gamma Flip.</p>
                <p class="text-[9px] text-slate-500 mt-1">Aproxima√ß√£o deste n√≠vel causa aumento s√∫bito na volatilidade impl√≠cita.</p>
            </div></div>`;
            document.getElementById('mmActionContent').innerHTML = mmHtml;

            // --- STRATEGIC POSITIONING ---
            let stratHtml = `<div class="space-y-3">`;
            
            // L√≥gica de Estrat√©gia por Regime e Pre√ßo
            if (isLongGamma) {
                if (Math.abs(distanceToFlip) < 2) {
                    stratHtml += createStratCard("IRON CONDOR / FLY", "Vencimento: Semanal (1-5 DTE)", "Pre√ßo preso entre muros. Lucro por decaimento de Theta em ambiente de baixa vol.", "emerald");
                } else {
                    stratHtml += createStratCard("CALENDAR SPREADS", "Vencimento: 15-30 DTE", "Explorar a diferen√ßa de IV entre vencimentos enquanto o pre√ßo lateraliza.", "blue");
                }
            } else {
                if (spot < lv.gammaFlip) {
                    stratHtml += createStratCard("LONG PUT / BEAR SPREAD", "Vencimento: Curto (0-3 DTE)", "O mercado est√° em regime de p√¢nico. Alvos na Put Wall. Foco em Delta/Gamma r√°pido.", "red");
                } else {
                    stratHtml += createStratCard("LONG CALL / BULL SPREAD", "Vencimento: 2-5 DTE", "Rompimento do Gamma Flip pode causar Gamma Squeeze at√© a Call Wall.", "green");
                }
            }
            
            // Insight de Vencimento
            const volConcentration = df.reduce((max, r) => r.volume > max.volume ? r : max, df[0]);
            if (volConcentration.volume > lv.totalVol * 0.4) {
                stratHtml += `<div class="p-3 bg-purple-500/10 rounded border border-purple-500/30">
                    <p class="text-[11px] text-purple-300 font-bold">‚ö†Ô∏è VENCIMENTO T√ÅTICO: 0 DTE / 1 DTE</p>
                    <p class="text-[10px] text-slate-400">Concentra√ß√£o extrema de volume no strike $${volConcentration.strike}. Indica apostas direcionais de curt√≠ssimo prazo.</p>
                </div>`;
            }
            
            stratHtml += `</div>`;
            document.getElementById('strategyContent').innerHTML = stratHtml;

            // Table Render
            document.getElementById('dataTable').innerHTML = df.map(row => {
                const isPin = row.strike === lv.gammaPin;
                return `
                <tr class="hover:bg-white/5 transition border-b border-white/5">
                    <td class="p-4 font-bold ${isPin ? 'text-purple-400' : 'text-slate-300'}">${row.strike.toFixed(2)}</td>
                    <td class="p-4">
                        <span class="px-2 py-0.5 rounded text-[8px] font-bold ${row.dominance === 'CALL' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                            ${row.dominance}
                        </span>
                    </td>
                    <td class="p-4 ${row.totalGex >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${(row.totalGex/1e3).toFixed(1)}k
                    </td>
                    <td class="p-4 text-cyan-500">${(row.totalOiNocional/1e3).toFixed(1)}k</td>
                    <td class="p-4 text-emerald-500">${(row.volume/1e3).toFixed(1)}k</td>
                    <td class="p-4">
                        <div class="w-16 h-1 bg-slate-800 rounded-full">
                            <div class="h-full bg-blue-500" style="width: ${Math.min(row.concentration * 5, 100)}%"></div>
                        </div>
                    </td>
                    <td class="p-4 text-right text-slate-500">${row.volRatio.toFixed(2)}</td>
                </tr>`;
            }).join('');

            renderChart(df, spot, lv);
        }

        function createStratCard(title, dte, desc, color) {
            return `<div class="p-3 bg-${color}-500/10 rounded border border-${color}-500/30">
                <p class="text-[11px] text-${color}-400 font-bold uppercase mb-1">${title}</p>
                <p class="text-[9px] text-slate-500 mb-1 font-mono">${dte}</p>
                <p class="text-[10px] text-slate-300 leading-tight">${desc}</p>
            </div>`;
        }

        function renderChart(df, spot, lv) {
            const ctx = document.getElementById('gexChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const showVol = document.getElementById('showVolumeLine').checked;
            const showOi = document.getElementById('showOiLine').checked;

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: df.map(r => r.strike),
                    datasets: [
                        {
                            label: 'Net GEX',
                            data: df.map(r => r.totalGex),
                            backgroundColor: df.map(r => r.totalGex >= 0 ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'),
                            borderWidth: 0, borderRadius: 2, yAxisID: 'y'
                        },
                        ...(showVol ? [{
                            label: 'Volume', type: 'line', data: df.map(r => r.volume),
                            borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, tension: 0.4, yAxisID: 'y1'
                        }] : []),
                        ...(showOi ? [{
                            label: 'OI Nocional', type: 'line', data: df.map(r => r.totalOiNocional),
                            borderColor: '#06b6d4', borderWidth: 2, borderDash: [3, 3], pointRadius: 0, tension: 0.4, yAxisID: 'y1'
                        }] : [])
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 9 } } },
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#475569', font: { size: 9 } } },
                        y1: { position: 'right', display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateData() {
            if (!lastRawData.length) return;
            const spot = parseFloat(document.getElementById('spotPrice').value);
            const calculated = calculateMetrics(lastRawData, spot);
            updateUI(calculated, getLevels(calculated), spot);
        }
    </script>
</body>
</html>
