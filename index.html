<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantGEX Terminal | Op√ß√µes & Gamma Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body {
            background-color: #020617;
            color: #f1f5f9;
            font-family: 'Inter', system-ui, sans-serif;
        }
        input[type="file"]::file-selector-button {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.2s;
        }
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }
        .status-pill {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400 flex items-center gap-2">
                    üìä QuantGEX Terminal <span class="text-xs font-mono bg-blue-500/20 px-2 py-1 rounded text-blue-300">v4.0 GREEKS PRO</span>
                </h1>
                <p class="text-slate-400">An√°lise de IV, DTE e Microestrutura de Market Making</p>
            </div>
            <div class="flex gap-4">
                <div class="glass-card p-3 rounded-lg text-center min-w-[120px]">
                    <span class="block text-[9px] uppercase text-slate-400 mb-1 font-bold">Spot</span>
                    <input type="number" id="spotPrice" value="100.00" step="0.01" class="bg-transparent text-lg font-bold w-full text-center outline-none text-white focus:text-blue-400 transition-colors">
                </div>
                <div class="glass-card p-3 rounded-lg text-center min-w-[120px]">
                    <span class="block text-[9px] uppercase text-slate-400 mb-1 font-bold">VIX / IV M√©dia</span>
                    <input type="number" id="avgIv" value="25" step="0.1" class="bg-transparent text-lg font-bold w-full text-center outline-none text-white focus:text-blue-400 transition-colors">
                </div>
            </div>
        </header>

        <!-- Configuration & Import -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="md:col-span-3 glass-card p-6 rounded-xl border-l-4 border-blue-500">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-sm font-semibold text-blue-300 uppercase tracking-wider">üìÅ Importar Dados Pro</h2>
                    <span class="text-[10px] text-slate-500 font-mono">Suporte: IV, Vencimento, Delta, Gamma, OI</span>
                </div>
                <input type="file" id="excelInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-400">
            </div>
            <div class="glass-card p-6 rounded-xl flex flex-col justify-center">
                <span class="text-xs text-slate-400 uppercase font-bold">Regime de Volatilidade</span>
                <div id="volRegimeValue" class="text-xl font-bold text-white mt-1">Normal</div>
                <div id="vannaBadge" class="mt-2 status-pill bg-slate-800 text-slate-400 text-center">Aguardando IV...</div>
            </div>
        </div>

        <!-- Metric Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
            <div class="glass-card p-4 rounded-xl border-t-2 border-green-500">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Call Wall</span>
                <div id="callWallValue" class="text-lg font-bold text-green-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-red-500">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Put Wall</span>
                <div id="putWallValue" class="text-lg font-bold text-red-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-orange-500">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Gamma Flip</span>
                <div id="gammaFlipValue" class="text-lg font-bold text-orange-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-cyan-500">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">DTE M√©dio</span>
                <div id="avgDteValue" class="text-lg font-bold text-cyan-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-purple-500">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Skew Absoluto</span>
                <div id="skewValue" class="text-lg font-bold text-purple-400">--</div>
            </div>
            <div class="glass-card p-4 rounded-xl border-t-2 border-yellow-500">
                <span class="text-[9px] text-slate-500 uppercase block font-bold">Total Delta Net</span>
                <div id="totalDeltaValue" class="text-lg font-bold text-yellow-400">--</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Visual Analytics -->
            <div class="lg:col-span-2 glass-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span> Distribui√ß√£o de Greeks e IV
                    </h3>
                </div>
                <div class="chart-container">
                    <canvas id="gexChart"></canvas>
                </div>
            </div>

            <!-- Tactics & Greeks Panel -->
            <div class="space-y-6">
                <!-- Vanna/Charm Insights -->
                <div class="glass-card p-6 rounded-xl border-b-4 border-indigo-600">
                    <h3 class="text-sm font-bold text-indigo-300 uppercase mb-4">üå™Ô∏è Din√¢mica de IV & Tempo</h3>
                    <div id="greeksInsights" class="space-y-4">
                        <p class="text-slate-500 text-[11px] italic">Importe dados de IV para ver a sensibilidade do hedge.</p>
                    </div>
                </div>

                <!-- Strategic Tactics -->
                <div class="glass-card p-6 rounded-xl border-b-4 border-emerald-600">
                    <h3 class="text-sm font-bold text-emerald-300 uppercase mb-4">üéØ Posicionamento T√°tico</h3>
                    <div id="tacticContent" class="space-y-3">
                        <!-- Conte√∫do din√¢mico -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Panel -->
        <div class="mt-8 glass-card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="font-bold text-xs uppercase text-slate-400 tracking-wider">Monitor de Greeks por Strike</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-black/40 text-slate-500 text-[9px] uppercase font-bold">
                        <tr>
                            <th class="p-4">Strike</th>
                            <th class="p-4">IV (%)</th>
                            <th class="p-4">GEX Net</th>
                            <th class="p-4">Delta Net</th>
                            <th class="p-4">Vencimento (DTE)</th>
                            <th class="p-4">Semsibilidade (Gamma/IV)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="divide-y divide-white/5 font-mono text-[11px]">
                        <tr><td colspan="6" class="p-8 text-center text-slate-500 italic">Nenhum dado processado</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let lastRawData = [];

        // UI Listeners
        document.getElementById('spotPrice').addEventListener('change', updateData);
        document.getElementById('avgIv').addEventListener('change', updateData);

        // --- EXCEL PARSER ---
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                processImportedData(json);
            };
            reader.readAsArrayBuffer(file);
        });

        function parseNum(val) {
            if (val === undefined || val === null || val === "") return 0;
            if (typeof val === 'number') return val;
            let clean = val.toString().replace(/R\$/g, '').replace(/\s/g, '').replace('%', '');
            if (clean.includes(',') && clean.includes('.')) clean = clean.replace(/\./g, '').replace(',', '.');
            else clean = clean.replace(',', '.');
            return parseFloat(clean) || 0;
        }

        function processImportedData(json) {
            lastRawData = json.map(row => {
                const findKey = (list) => {
                    const keys = Object.keys(row);
                    return keys.find(k => list.some(l => k.toLowerCase().trim() === l.toLowerCase())) || null;
                };

                return {
                    tipo: (row[findKey(['tipo', 'call/put', 'type', 'c/p'])] || "").toString().toLowerCase(),
                    strike: parseNum(row[findKey(['strike', 'pre√ßo exerc√≠cio', 'preco', 'exercicio'])]),
                    oi: parseNum(row[findKey(['oi', 'open interest', 'aberto', 'contratos'])]),
                    gamma: parseNum(row[findKey(['gamma', 'gama', 'gex'])]),
                    delta: parseNum(row[findKey(['delta', 'dlt'])]),
                    iv: parseNum(row[findKey(['iv', 'vol impl√≠cita', 'volatilidade', 'implied vol'])]),
                    dte: parseNum(row[findKey(['dte', 'dias vencimento', 'prazo', 'vencimento'])]) || 30
                };
            }).filter(r => r.strike > 0);
            updateData();
        }

        // --- QUANT ENGINE v4.0 ---
        function calculateMetrics(data, spot) {
            const strikeMap = {};
            data.forEach(row => {
                if (!strikeMap[row.strike]) {
                    strikeMap[row.strike] = { strike: row.strike, gexCall: 0, gexPut: 0, deltaCall: 0, deltaPut: 0, ivSum: 0, ivCount: 0, dte: 0 };
                }
                const gexVal = row.gamma * row.oi * 100 * spot;
                const deltaVal = row.delta * row.oi * 100;
                
                if (row.tipo.includes('c')) {
                    strikeMap[row.strike].gexCall += gexVal;
                    strikeMap[row.strike].deltaCall += deltaVal;
                } else {
                    strikeMap[row.strike].gexPut -= gexVal;
                    strikeMap[row.strike].deltaPut += deltaVal;
                }
                strikeMap[row.strike].ivSum += row.iv;
                strikeMap[row.strike].ivCount++;
                strikeMap[row.strike].dte = row.dte;
            });

            return Object.values(strikeMap).map(s => {
                const avgIv = s.ivCount > 0 ? s.ivSum / s.ivCount : 0;
                const totalGex = s.gexCall + s.gexPut;
                const totalDelta = s.deltaCall + s.deltaPut;
                return { ...s, avgIv, totalGex, totalDelta };
            }).sort((a,b) => a.strike - b.strike);
        }

        function updateUI(df, spot) {
            if (!df.length) return;

            const callWall = df.reduce((prev, curr) => (curr.gexCall > prev.gexCall) ? curr : prev).strike;
            const putWall = df.reduce((prev, curr) => (curr.gexPut < prev.gexPut) ? curr : prev).strike;
            const gammaFlip = df.reduce((prev, curr) => (Math.abs(curr.totalGex) < Math.abs(prev.totalGex)) ? curr : prev).strike;
            const avgDte = df.reduce((a, b) => a + b.dte, 0) / df.length;
            const totalDelta = df.reduce((a, b) => a + b.totalDelta, 0);

            // Skew calculation (IV Put vs IV Call around ATM)
            const atmStrike = df.reduce((prev, curr) => Math.abs(curr.strike - spot) < Math.abs(prev.strike - spot) ? curr : prev);
            document.getElementById('skewValue').innerText = `${atmStrike.avgIv.toFixed(1)}%`;
            
            document.getElementById('callWallValue').innerText = `$ ${callWall.toFixed(2)}`;
            document.getElementById('putWallValue').innerText = `$ ${putWall.toFixed(2)}`;
            document.getElementById('gammaFlipValue').innerText = `$ ${gammaFlip.toFixed(2)}`;
            document.getElementById('avgDteValue').innerText = `${avgDte.toFixed(0)} dias`;
            document.getElementById('totalDeltaValue').innerText = `${(totalDelta/1e6).toFixed(1)}M`;

            // Volatilidade Regime Logic
            const ivInput = parseFloat(document.getElementById('avgIv').value);
            const volRegime = document.getElementById('volRegimeValue');
            const vannaBadge = document.getElementById('vannaBadge');
            
            if (ivInput > 30) {
                volRegime.innerText = "Alta Vol";
                volRegime.className = "text-xl font-bold text-red-400 mt-1";
                vannaBadge.innerText = "‚ö†Ô∏è Vanna Positivo: Risco de Vol Crush";
                vannaBadge.className = "mt-2 status-pill bg-red-500/20 text-red-400 text-center";
            } else {
                volRegime.innerText = "Baixa Vol";
                volRegime.className = "text-xl font-bold text-green-400 mt-1";
                vannaBadge.innerText = "Charm Ativo: Decaimento de Delta";
                vannaBadge.className = "mt-2 status-pill bg-green-500/20 text-green-400 text-center";
            }

            // --- GREEKS INSIGHTS ---
            let greeksHtml = `<div class="space-y-3">`;
            if (avgDte < 7) {
                greeksHtml += `<div class="p-3 bg-red-500/10 border border-red-500/20 rounded">
                    <p class="text-[10px] text-red-400 font-bold uppercase">üí£ Risco de Gamma (Fim de Jogo)</p>
                    <p class="text-[10px] text-slate-400 mt-1">Vencimento muito pr√≥ximo. Movimentos no Spot for√ßar√£o re-hedges violentos dos dealers.</p>
                </div>`;
            } else {
                greeksHtml += `<div class="p-3 bg-indigo-500/10 border border-indigo-500/20 rounded">
                    <p class="text-[10px] text-indigo-400 font-bold uppercase">‚è≥ Domin√¢ncia de Theta/Charm</p>
                    <p class="text-[10px] text-slate-400 mt-1">Exposi√ß√£o est√°vel. O tempo √© o maior fator de mudan√ßa nos deltas dos MMs hoje.</p>
                </div>`;
            }
            
            const netGex = df.reduce((a, b) => a + b.totalGex, 0);
            if (netGex < 0 && ivInput > 25) {
                greeksHtml += `<div class="p-3 bg-orange-500/10 border border-orange-500/20 rounded">
                    <p class="text-[10px] text-orange-400 font-bold uppercase">üìâ Feedback Loop Negativo</p>
                    <p class="text-[10px] text-slate-400 mt-1">Short Gamma + Alta IV. Qualquer queda de pre√ßo aumenta a IV, que por sua vez aumenta a necessidade de venda dos dealers (Vanna).</p>
                </div>`;
            }
            document.getElementById('greeksInsights').innerHTML = greeksHtml;

            // --- TACTICS ---
            let tacticHtml = `<div class="space-y-3">`;
            if (avgDte < 5 && netGex > 0) {
                tacticHtml += createTacticCard("0DTE GAMMA SCALPING", "Aproveite a estabilidade para vender vol curta ou operar revers√µes nas Walls.", "emerald");
            } else if (ivInput > 35) {
                tacticHtml += createTacticCard("VOLATILITY SHORT (VEGA)", "Venda de travas de linha (Credit Spreads) para capturar o colapso da IV ap√≥s o evento.", "blue");
            } else {
                tacticHtml += createTacticCard("LONG CONVEXITY", "Compra de Strangles ou Puts longas. Risco de cauda barato devido √† IV baixa.", "purple");
            }
            document.getElementById('tacticContent').innerHTML = tacticHtml;

            // Table
            document.getElementById('dataTable').innerHTML = df.map(row => `
                <tr class="hover:bg-white/5 transition">
                    <td class="p-4 font-bold text-slate-300">${row.strike.toFixed(2)}</td>
                    <td class="p-4 text-purple-400">${row.avgIv.toFixed(1)}%</td>
                    <td class="p-4 ${row.totalGex >= 0 ? 'text-green-400' : 'text-red-400'}">${(row.totalGex/1e3).toFixed(1)}k</td>
                    <td class="p-4 text-yellow-500">${(row.totalDelta/1e3).toFixed(1)}k</td>
                    <td class="p-4 text-cyan-400 font-mono">${row.dte}d</td>
                    <td class="p-4 text-slate-500 text-[10px]">${(Math.abs(row.totalGex)/row.avgIv).toFixed(2)}</td>
                </tr>
            `).join('');

            renderChart(df, spot);
        }

        function createTacticCard(title, desc, color) {
            return `<div class="p-3 bg-${color}-500/10 rounded border border-${color}-500/30">
                <p class="text-[11px] text-${color}-400 font-bold uppercase">${title}</p>
                <p class="text-[10px] text-slate-300 leading-tight mt-1">${desc}</p>
            </div>`;
        }

        function renderChart(df, spot) {
            const ctx = document.getElementById('gexChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: df.map(r => r.strike),
                    datasets: [
                        {
                            label: 'Net GEX',
                            data: df.map(r => r.totalGex),
                            backgroundColor: df.map(r => r.totalGex >= 0 ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'),
                            yAxisID: 'y'
                        },
                        {
                            label: 'IV %',
                            type: 'line',
                            data: df.map(r => r.avgIv),
                            borderColor: '#a855f7',
                            borderWidth: 2,
                            pointRadius: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 9 } } },
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#64748b', font: { size: 9 } } },
                        y1: { position: 'right', grid: { display: false }, ticks: { color: '#a855f7', font: { size: 9 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateData() {
            if (!lastRawData.length) return;
            const spot = parseFloat(document.getElementById('spotPrice').value);
            const calculated = calculateMetrics(lastRawData, spot);
            updateUI(calculated, spot);
        }
    </script>
</body>
</html>
