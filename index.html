<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantGEX Terminal | Op√ß√µes & Gamma Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS para processar Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body {
            background-color: #020617;
            color: #f1f5f9;
        }
        input[type="file"]::file-selector-button {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            margin-right: 1rem;
            transition: background 0.2s;
        }
        .pin-label {
            background: #a855f7;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">üìä QuantGEX Terminal <span class="text-sm font-normal text-slate-500">v2.1 Pro</span></h1>
                <p class="text-slate-400">Microestrutura, Volume Financeiro e Delta Hedging</p>
            </div>
            <div class="flex gap-4">
                <div class="glass-card p-3 rounded-lg text-center min-w-[150px]">
                    <span class="block text-xs uppercase text-slate-400">Spot Price</span>
                    <input type="number" id="spotPrice" value="100.00" step="0.01" class="bg-transparent text-xl font-bold w-full text-center outline-none text-white">
                </div>
            </div>
        </header>

        <!-- Import Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="md:col-span-2 glass-card p-6 rounded-xl">
                <h2 class="text-sm font-semibold mb-4 text-blue-300 uppercase tracking-wider">üìÅ Importar Cadeia de Op√ß√µes</h2>
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <input type="file" id="excelInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-400">
                    <p class="text-[10px] text-slate-500 leading-tight">
                        Formato: <span class="text-slate-300">ticker, tipo, strike, OI, Gamma, Volume</span>
                    </p>
                </div>
            </div>
            <div class="glass-card p-6 rounded-xl flex flex-col justify-center">
                <span class="text-xs text-slate-400 uppercase">Volume Financeiro Total</span>
                <div id="totalVolumeVal" class="text-xl font-bold text-emerald-400">--</div>
                <p class="text-[10px] text-slate-500 italic">Total negociado na sess√£o importada</p>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
            <div class="glass-card p-5 rounded-xl border-t-4 border-blue-500">
                <span class="text-xs text-slate-400 uppercase">Net GEX Agregado</span>
                <div id="netGexValue" class="text-xl font-bold text-white">--</div>
                <div id="regimeBadge" class="mt-1 inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase">...</div>
            </div>
            <div class="glass-card p-5 rounded-xl border-t-4 border-green-500">
                <span class="text-xs text-slate-400 uppercase">Call Wall (Resistance)</span>
                <div id="callWallValue" class="text-xl font-bold text-white">--</div>
                <span id="callWallOi" class="text-[10px] text-slate-500">--</span>
            </div>
            <div class="glass-card p-5 rounded-xl border-t-4 border-red-500">
                <span class="text-xs text-slate-400 uppercase">Put Wall (Support)</span>
                <div id="putWallValue" class="text-xl font-bold text-white">--</div>
                <span id="putWallOi" class="text-[10px] text-slate-500">--</span>
            </div>
            <div class="glass-card p-5 rounded-xl border-t-4 border-orange-500">
                <span class="text-xs text-slate-400 uppercase">Gamma Flip (Pivot)</span>
                <div id="gammaFlipValue" class="text-xl font-bold text-white">--</div>
                <span class="text-[10px] text-slate-500 italic">Vara de Volatilidade</span>
            </div>
            <div class="glass-card p-5 rounded-xl border-t-4 border-purple-500">
                <span class="text-xs text-slate-400 uppercase">Gamma Pin üß≤</span>
                <div id="gammaPinValue" class="text-xl font-bold text-white">--</div>
                <span class="text-[10px] text-slate-500 italic">Atra√ß√£o de Vencimento</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Gr√°fico -->
            <div class="lg:col-span-2 glass-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-semibold text-slate-200 uppercase tracking-widest">Exposi√ß√£o de Gamma vs Concentra√ß√£o de Volume</h3>
                    <div class="flex gap-2">
                        <span class="flex items-center gap-1 text-[10px] text-slate-400"><span class="w-2 h-2 bg-green-500 rounded-full"></span> Pos GEX</span>
                        <span class="flex items-center gap-1 text-[10px] text-slate-400"><span class="w-2 h-2 bg-red-500 rounded-full"></span> Neg GEX</span>
                        <span class="flex items-center gap-1 text-[10px] text-slate-400"><span class="w-2 h-2 bg-blue-400 rounded-full"></span> Volume</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="gexChart"></canvas>
                </div>
            </div>

            <!-- Estrat√©gias -->
            <div class="glass-card p-6 rounded-xl">
                <h3 class="text-lg font-semibold mb-4 text-slate-200 flex items-center gap-2">
                    üß† Quant Insights
                </h3>
                <div id="strategyContent" class="space-y-4">
                    <div class="animate-pulse flex space-y-4 flex-col">
                        <div class="h-4 bg-slate-800 rounded w-3/4"></div>
                        <div class="h-10 bg-slate-800 rounded"></div>
                        <div class="h-20 bg-slate-800 rounded"></div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-white/5">
                    <h4 class="text-xs font-bold text-blue-400 mb-2 uppercase">An√°lise de Fluxo:</h4>
                    <ul class="text-[10px] text-slate-500 space-y-1">
                        <li>‚Ä¢ <strong>Volume > OI:</strong> Indica entrada de novas posi√ß√µes e poss√≠vel mudan√ßa de regime.</li>
                        <li>‚Ä¢ <strong>Pinning Real:</strong> Confirmado quando o Gamma Pin coincide com alto volume financeiro.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tabela -->
        <div class="mt-8 glass-card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="font-semibold text-sm">GEX, Volume & Liquidez por N√≠vel</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-black/20 text-slate-400 text-[10px] uppercase">
                        <tr>
                            <th class="p-4">Strike</th>
                            <th class="p-4">GEX Net Nocional</th>
                            <th class="p-4">Volume Financeiro</th>
                            <th class="p-4">OI Total</th>
                            <th class="p-4">GEX/Vol Ratio</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="divide-y divide-white/5 font-mono text-xs">
                        <tr><td colspan="5" class="p-8 text-center text-slate-500 italic">Importe dados para iniciar a an√°lise quantitativa</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let lastRawData = [];

        // --- EXCEL PARSER ---
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                processImportedData(json);
            };
            reader.readAsArrayBuffer(file);
        });

        function processImportedData(json) {
            lastRawData = json.map(row => ({
                ticker: row.ticker || row.Ticker || "ASSET",
                tipo: (row.tipo || row.Tipo || "").toLowerCase(),
                strike: parseFloat(row.strike || row.Strike),
                oi: parseFloat(row.OI || row.oi || row.open_interest),
                gamma: parseFloat(row.Gamma || row.gamma),
                volume: parseFloat(row.volume || row.Volume || 0)
            })).filter(r => !isNaN(r.strike) && !isNaN(r.oi) && !isNaN(r.gamma));
            updateData();
        }

        // --- QUANT ENGINE ---
        function calculateGEX(data, spot) {
            const strikeMap = {};
            data.forEach(row => {
                if (!strikeMap[row.strike]) strikeMap[row.strike] = { strike: row.strike, gexCall: 0, gexPut: 0, oi: 0, volume: 0, ticker: row.ticker };
                
                const gexVal = row.gamma * row.oi * 100 * spot;
                
                if (row.tipo === 'call' || row.tipo === 'c') {
                    strikeMap[row.strike].gexCall += gexVal;
                } else {
                    strikeMap[row.strike].gexPut -= gexVal;
                }
                strikeMap[row.strike].oi += row.oi;
                strikeMap[row.strike].volume += row.volume;
            });

            return Object.values(strikeMap).map(s => ({ 
                ...s, 
                totalGex: s.gexCall + s.gexPut,
                volRatio: s.volume > 0 ? (Math.abs(s.totalGex) / s.volume) : 0
            })).sort((a,b) => a.strike - b.strike);
        }

        function getLevels(df) {
            const callWallRow = df.reduce((prev, curr) => (curr.gexCall > prev.gexCall) ? curr : prev);
            const putWallRow = df.reduce((prev, curr) => (curr.gexPut < prev.gexPut) ? curr : prev);
            
            const gammaPin = df.reduce((prev, curr) => 
                (Math.abs(curr.gexCall) + Math.abs(curr.gexPut) > Math.abs(prev.gexCall) + Math.abs(prev.gexPut)) ? curr : prev
            ).strike;

            const gammaFlip = df.reduce((prev, curr) => (Math.abs(curr.totalGex) < Math.abs(prev.totalGex)) ? curr : prev).strike;
            const netGex = df.reduce((sum, curr) => sum + curr.totalGex, 0);
            const totalVol = df.reduce((sum, curr) => sum + curr.volume, 0);

            return { 
                callWall: callWallRow.strike, 
                callWallOi: callWallRow.oi,
                putWall: putWallRow.strike, 
                putWallOi: putWallRow.oi,
                gammaPin, 
                gammaFlip, 
                netGex,
                totalVol
            };
        }

        function updateUI(df, levels, spot) {
            document.getElementById('netGexValue').innerText = `R$ ${levels.netGex.toLocaleString('pt-BR', {maximumFractionDigits: 0})}`;
            document.getElementById('totalVolumeVal').innerText = `R$ ${levels.totalVol.toLocaleString('pt-BR', {maximumFractionDigits: 0})}`;
            document.getElementById('callWallValue').innerText = `$ ${levels.callWall.toFixed(2)}`;
            document.getElementById('callWallOi').innerText = `OI: ${levels.callWallOi.toLocaleString()}`;
            document.getElementById('putWallValue').innerText = `$ ${levels.putWall.toFixed(2)}`;
            document.getElementById('putWallOi').innerText = `OI: ${levels.putWallOi.toLocaleString()}`;
            document.getElementById('gammaFlipValue').innerText = `$ ${levels.gammaFlip.toFixed(2)}`;
            document.getElementById('gammaPinValue').innerText = `$ ${levels.gammaPin.toFixed(2)}`;

            const isPos = levels.netGex > 0;
            const badge = document.getElementById('regimeBadge');
            badge.innerText = isPos ? 'Gamma Longo (Est√°vel)' : 'Gamma Curto (Inst√°vel)';
            badge.className = `mt-1 inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase ${isPos ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;

            // Advanced Insights based on Volume
            const topVolStrike = df.reduce((prev, curr) => (curr.volume > prev.volume) ? curr : prev);
            let stratHtml = `<div class="space-y-3">`;
            
            if (topVolStrike.strike === levels.gammaPin) {
                stratHtml += `<div class="p-3 rounded-lg bg-purple-500/10 border border-purple-500/30">
                    <p class="text-purple-400 font-bold text-xs uppercase mb-1">üéØ Pinning de Alta Confian√ßa</p>
                    <p class="text-[11px]">O maior Volume Financeiro coincide com o Gamma Pin em $${levels.gammaPin}. Probabilidade estat√≠stica de ancoragem de pre√ßo extrema para este n√≠vel.</p>
                </div>`;
            }

            if (topVolStrike.volume > (levels.totalVol * 0.3)) {
                stratHtml += `<div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
                    <p class="text-yellow-400 font-bold text-xs uppercase mb-1">üî• Anomalia de Volume</p>
                    <p class="text-[11px]">O strike $${topVolStrike.strike} concentra mais de 30% do volume financeiro total. Fique atento a uma nova "parede" se formando fora do Open Interest atual.</p>
                </div>`;
            }

            stratHtml += `<div class="p-3 rounded-lg bg-slate-800 border border-white/5">
                <p class="text-slate-400 font-bold text-xs uppercase mb-1">üìä Perfil da Sess√£o</p>
                <p class="text-[11px]">Domin√¢ncia de volume no strike $${topVolStrike.strike}. Rela√ß√£o GEX/Volume atual sugere ${levels.netGex > 0 ? 'distribui√ß√£o' : 'acumula√ß√£o de prote√ß√£o'}.</p>
            </div></div>`;
            
            document.getElementById('strategyContent').innerHTML = stratHtml;

            // Table update
            document.getElementById('dataTable').innerHTML = df.map(row => `
                <tr class="hover:bg-white/5 transition ${row.strike === levels.gammaPin ? 'bg-purple-500/10' : ''}">
                    <td class="p-4 font-bold">
                        ${row.strike.toFixed(2)}
                    </td>
                    <td class="p-4 ${row.totalGex >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${row.totalGex.toLocaleString('pt-BR', {maximumFractionDigits:0})}
                    </td>
                    <td class="p-4 text-emerald-400">
                        ${row.volume.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                    </td>
                    <td class="p-4 text-slate-400">${row.oi.toLocaleString()}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <div class="flex-1 h-1 bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500" style="width: ${Math.min(row.volRatio * 10, 100)}%"></div>
                            </div>
                            <span class="text-[9px]">${row.volRatio.toFixed(2)}</span>
                        </div>
                    </td>
                </tr>
            `).join('');

            renderChart(df, spot, levels);
        }

        function renderChart(df, spot, levels) {
            const ctx = document.getElementById('gexChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: df.map(r => r.strike),
                    datasets: [
                        {
                            label: 'GEX Net',
                            data: df.map(r => r.totalGex),
                            backgroundColor: df.map(r => r.totalGex >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                            borderRadius: 4,
                            yAxisID: 'y',
                        },
                        {
                            label: 'Volume Financeiro',
                            type: 'line',
                            data: df.map(r => r.volume),
                            borderColor: '#60a5fa',
                            borderWidth: 2,
                            pointRadius: 2,
                            fill: false,
                            yAxisID: 'y1',
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#64748b', font: { size: 10 } } 
                        },
                        y: { 
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#64748b', font: { size: 10 } } 
                        },
                        y1: {
                            position: 'right',
                            grid: { display: false },
                            ticks: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: R$ ${ctx.raw.toLocaleString('pt-BR')}`
                            }
                        }
                    }
                }
            });
        }

        function updateData() {
            if (lastRawData.length === 0) return;
            const spot = parseFloat(document.getElementById('spotPrice').value);
            const calculated = calculateGEX(lastRawData, spot);
            const levels = getLevels(calculated);
            updateUI(calculated, levels, spot);
        }

        document.getElementById('spotPrice').addEventListener('change', updateData);
    </script>
</body>
</html>
